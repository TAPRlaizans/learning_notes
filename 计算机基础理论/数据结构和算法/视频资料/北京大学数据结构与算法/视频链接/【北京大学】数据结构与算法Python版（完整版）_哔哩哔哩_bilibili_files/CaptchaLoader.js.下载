!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).CaptchaLoader={})}(this,(function(e){"use strict";function r(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,o=Array(r);n<r;n++)o[n]=e[n];return o}function n(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,t,i,u,s=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===r);else for(;!(c=(o=i.call(n)).done)&&(s.push(o.value),s.length!==r);c=!0);}catch(e){l=!0,t=e}finally{try{if(!c&&null!=n.return&&(u=n.return(),Object(u)!==u))return}finally{if(l)throw t}}return s}}(e,n)||function(e,n){if(e){if("string"==typeof e)return r(e,n);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?r(e,n):void 0}}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(){return o=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},o.apply(null,arguments)}var t=function(e){"undefined"!=typeof window&&window.__BILI_X_ENGINE_SCRIPT_CACHE__&&void 0!==window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]&&delete window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]},i=function(e,r){if("undefined"==typeof window)return Promise.reject(new Error("window is not defined"));var n,o=e=e.replace(/^https?:\/\//,"//"),i=(n=o,"undefined"==typeof window?null:window.__BILI_X_ENGINE_SCRIPT_CACHE__&&window.__BILI_X_ENGINE_SCRIPT_CACHE__[n]||null);if(null!=i&&i.promise)return i.promise;var u=new Promise((function(n,o){var t=document.createElement("script");t.src=e,null!=r&&r.behavior&&t.setAttribute(r.behavior,""),t.onload=function(){var t=window;if(null!=r&&r.lib)return t[r.lib]?n(t[r.lib]):o(new Error('Failed to access library "'+r.lib+'" from '+e));n(null)},t.onerror=function(){o(new Error("Failed to load "+e)),document.head.removeChild(t)},document.head.appendChild(t)}));return function(e,r){"undefined"!=typeof window&&(window.__BILI_X_ENGINE_SCRIPT_CACHE__||(window.__BILI_X_ENGINE_SCRIPT_CACHE__={}),window.__BILI_X_ENGINE_SCRIPT_CACHE__[e]=r)}(o,{promise:u,lib:null==r?void 0:r.lib}),u.then((function(){!1===(null==r?void 0:r.cache)&&t(o)})).catch((function(){!1===(null==r?void 0:r.cache)&&t(o)})),u},u=function(e){return Promise.resolve(function(){try{return window.ReporterPb?Promise.resolve(window.ReporterPb):Promise.resolve(i("//s1.hdslb.com/bfs/seed/jinkela/short/reporter-pb/index.js",{lib:"ReporterPb"}))}catch(e){return Promise.reject(e)}}()).then((function(r){return new r(e)}))},s=function(){try{return f||(f=u({spmPrefix:c,sampleRate:1,autoPv:!1,batch:{batchSize:10,batchTime:500},feature:{tech:!0}}).then((function(e){return d=e}))),Promise.resolve(f)}catch(e){return Promise.reject(e)}},c="333.1268",l={},a={},d=null,f=null;function _(e){var r,n,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"custom";(t=Object.assign({},a,t)).businessSpmid||(t.businessSpmid=(n=null===(r=document.getElementsByTagName("meta").spm_prefix)||void 0===r?void 0:r.content)?n+".0.0":"0.0.0.0"),function(e){var r=e.type,n=e.event,t=e.msg;try{var i=function(){d.tech(n,o({type:r},t))};n=n.split(".").length<2?n+=".0":n,n="".concat(c,".").concat(n);var u=function(){if(!d)return Promise.resolve(s()).then((function(){}))}();return Promise.resolve(u&&u.then?u.then(i):i())}catch(e){return Promise.reject(e)}}({type:i,event:e,msg:t})}function w(e){l[e]=Date.now()}function m(e,r){if(l[e]){var n=Date.now()-l[e];_(e,Object.assign({time:n},r)),delete l[e]}}function h(e,r){try{var n=e()}catch(e){return r(e)}return n&&n.then?n.then(void 0,r):n}var P=function(e){try{if(window._loadLogicPromise_)return Promise.resolve(window._loadLogicPromise_);return window._loadLogicPromise_=function(){try{return Promise.resolve(h((function(){return w("logic"),Promise.resolve(g(e)).then((function(){var e=window.useCaptcha;return delete window.useCaptcha,m("logic",{result:"success"}),e}))}),(function(){throw window._loadLogicPromise_=null,m("logic",{result:"failure",url:e}),new Error("加载脚本失败")})))}catch(e){return Promise.reject(e)}}(),Promise.resolve(window._loadLogicPromise_)}catch(e){return Promise.reject(e)}},v=function(e){try{if(window._loadSourcePromise_)return Promise.resolve(window._loadSourcePromise_);return window._loadSourcePromise_=function(){try{return Promise.resolve(h((function(){return w("source"),Promise.resolve(g(e)).then((function(){return m("source",{result:"success"}),!0}))}),(function(){throw window._loadSourcePromise_=null,m("source",{result:"failure",url:e}),new Error("加载source脚本失败")})))}catch(e){return Promise.reject(e)}}(),Promise.resolve(window._loadSourcePromise_)}catch(e){return Promise.reject(e)}},p=function(){try{if(window._loadConfigPromise_)return Promise.resolve(window._loadConfigPromise_);return window._loadConfigPromise_=function(){try{return Promise.resolve(h((function(){return w("config"),Promise.resolve(function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{method:"GET",headers:{}},n=r.method,o=r.headers,t=r.data;return new Promise((function(r,i){var u=new XMLHttpRequest;for(var s in u.onreadystatechange=function(){if(4===this.readyState&&200===this.status)try{r(JSON.parse(this.response||this.responseText))}catch(e){r(this.response||this.responseText)}else 4===this.readyState&&i()},u.onerror=i,u.ontimeout=i,u.withCredentials=!0,u.open(n,e),o)u.setRequestHeader(s,o[s]);u.send(t)}))}(y)).then((function(e){return m("config",{result:"success"}),e}))}),(function(){throw window._loadConfigPromise_=null,m("config",{result:"failure"}),new Error("加载配置失败")})))}catch(e){return Promise.reject(e)}}(),Promise.resolve(window._loadConfigPromise_)}catch(e){return Promise.reject(e)}},y="//api.bilibili.com/x/web-frontend/risk/config";function g(e){return new Promise((function(r,n){var o=document.createElement("script");o.src=e,o.onload=function(){r()},o.onerror=function(){n()},document.body.appendChild(o)}))}window._loadConfigPromise_=window._loadConfigPromise_||null,window._loadLogicPromise_=window._loadLogicPromise_||null,window._loadSourcePromise_=window._loadSourcePromise_||null,e.load=function(){return Promise.resolve(p()).then((function(e){var r=[P(e.logic)];return e.source&&r.push(v(e.source)),Promise.resolve(Promise.all(r)).then((function(e){return n(e,1)[0]}))}))}}));
